CREATE DATABASE aml_tm;
USE aml_tm;

CREATE TABLE transactions (
	step INT PRIMARY KEY,
    type VARCHAR(20),
    amount DECIMAL(15,2),
    nameOrig VARCHAR(50),
    oldbalanceOrg DECIMAL(15,2),
    newbalanceOrig DECIMAL(15,2),
    nameDest VARCHAR(50),
    oldbalanceDest DECIMAL(15,2),
    newbalanceDest DECIMAL(15,2),
    isFraud INT,
    IsFlaggedFraud INT
);

INSERT INTO transactions
(step, type, amount, nameOrig, oldbalanceOrg, newbalanceOrig, nameDest, oldbalanceDest, newbalanceDest, isFraud, isFlaggedFraud)
VALUES
(1,'TRANSFER',950000,'C1001',1200000,250000,'C2001',300000,1250000,0,0),
(2,'TRANSFER',980000,'C1001',250000,0,'C2002',500000,1480000,1,1),
(3,'CASH_OUT',980000,'C2002',1480000,500000,'CASH1',0,0,1,1),
(4,'PAYMENT',5000,'C1002',20000,15000,'M1001',0,0,0,0),
(5,'TRANSFER',1500000,'C1003',2000000,500000,'C2003',100000,1600000,1,1),
(6,'CASH_OUT',1500000,'C2003',1600000,100000,'CASH2',0,0,1,1),
(7,'TRANSFER',200000,'C1004',300000,100000,'C2004',200000,400000,0,0),
(8,'TRANSFER',990000,'C1001',1000000,10000,'C2005',50000,1040000,1,1),
(9,'CASH_OUT',990000,'C2005',1040000,50000,'CASH3',0,0,1,1),
(10,'PAYMENT',8000,'C1005',15000,7000,'M1002',0,0,0,0),

(11,'TRANSFER',300000,'C1006',500000,200000,'C2006',100000,400000,0,0),
(12,'TRANSFER',970000,'C1006',200000,0,'C2007',300000,1270000,1,1),
(13,'CASH_OUT',970000,'C2007',1270000,300000,'CASH4',0,0,1,1),
(14,'PAYMENT',6000,'C1007',20000,14000,'M1003',0,0,0,0),
(15,'TRANSFER',1200000,'C1008',1500000,300000,'C2008',200000,1400000,1,1),
(16,'CASH_OUT',1200000,'C2008',1400000,200000,'CASH5',0,0,1,1),
(17,'TRANSFER',450000,'C1009',600000,150000,'C2009',300000,750000,0,0),
(18,'PAYMENT',4000,'C1010',10000,6000,'M1004',0,0,0,0),
(19,'TRANSFER',980000,'C1011',1200000,220000,'C2010',400000,1380000,1,1),
(20,'CASH_OUT',980000,'C2010',1380000,400000,'CASH6',0,0,1,1),

(21,'TRANSFER',950000,'C1012',1100000,150000,'C2011',250000,1200000,0,0),
(22,'TRANSFER',960000,'C1012',150000,0,'C2012',300000,1260000,1,1),
(23,'CASH_OUT',960000,'C2012',1260000,300000,'CASH7',0,0,1,1),
(24,'PAYMENT',7000,'C1013',18000,11000,'M1005',0,0,0,0),
(25,'TRANSFER',1300000,'C1014',1700000,400000,'C2013',150000,1450000,1,1),
(26,'CASH_OUT',1300000,'C2013',1450000,150000,'CASH8',0,0,1,1),
(27,'TRANSFER',350000,'C1015',500000,150000,'C2014',200000,550000,0,0),
(28,'PAYMENT',9000,'C1016',20000,11000,'M1006',0,0,0,0),
(29,'TRANSFER',990000,'C1017',1250000,260000,'C2015',350000,1340000,1,1),
(30,'CASH_OUT',990000,'C2015',1340000,350000,'CASH9',0,0,1,1),

(31,'TRANSFER',940000,'C1018',1200000,260000,'C2016',300000,1240000,0,0),
(32,'PAYMENT',6000,'C1019',16000,10000,'M1007',0,0,0,0),
(33,'TRANSFER',1600000,'C1020',1900000,300000,'C2017',200000,1800000,1,1),
(34,'CASH_OUT',1600000,'C2017',1800000,200000,'CASH10',0,0,1,1),
(35,'TRANSFER',480000,'C1021',700000,220000,'C2018',300000,780000,0,0),
(36,'PAYMENT',5000,'C1022',15000,10000,'M1008',0,0,0,0),
(37,'TRANSFER',980000,'C1023',1100000,120000,'C2019',400000,1380000,1,1),
(38,'CASH_OUT',980000,'C2019',1380000,400000,'CASH11',0,0,1,1),
(39,'TRANSFER',420000,'C1024',600000,180000,'C2020',250000,670000,0,0),
(40,'PAYMENT',7500,'C1025',18000,10500,'M1009',0,0,0,0),

(41,'TRANSFER',1450000,'C1026',1750000,300000,'C2021',200000,1650000,1,1),
(42,'CASH_OUT',1450000,'C2021',1650000,200000,'CASH12',0,0,1,1),
(43,'TRANSFER',360000,'C1027',500000,140000,'C2022',260000,620000,0,0),
(44,'PAYMENT',6500,'C1028',17000,10500,'M1010',0,0,0,0),
(45,'TRANSFER',990000,'C1029',1200000,210000,'C2023',300000,1290000,1,1),
(46,'CASH_OUT',990000,'C2023',1290000,300000,'CASH13',0,0,1,1),
(47,'TRANSFER',410000,'C1030',600000,190000,'C2024',200000,610000,0,0),
(48,'PAYMENT',8500,'C1031',20000,11500,'M1011',0,0,0,0),
(49,'TRANSFER',1700000,'C1032',2000000,300000,'C2025',250000,1950000,1,1),
(50,'CASH_OUT',1700000,'C2025',1950000,250000,'CASH14',0,0,1,1),

(51,'TRANSFER',450000,'C1033',650000,200000,'C2026',350000,800000,0,0),
(52,'PAYMENT',5000,'C1034',14000,9000,'M1012',0,0,0,0),
(53,'TRANSFER',980000,'C1035',1150000,170000,'C2027',300000,1280000,1,1),
(54,'CASH_OUT',980000,'C2027',1280000,300000,'CASH15',0,0,1,1),
(55,'TRANSFER',390000,'C1036',600000,210000,'C2028',250000,640000,0,0),
(56,'PAYMENT',7200,'C1037',18000,10800,'M1013',0,0,0,0),
(57,'TRANSFER',1550000,'C1038',1800000,250000,'C2029',300000,1850000,1,1),
(58,'CASH_OUT',1550000,'C2029',1850000,300000,'CASH16',0,0,1,1),
(59,'TRANSFER',470000,'C1039',700000,230000,'C2030',200000,670000,0,0),
(60,'PAYMENT',6300,'C1040',16000,9700,'M1014',0,0,0,0),

(61,'TRANSFER',990000,'C1041',1200000,210000,'C2031',350000,1340000,1,1),
(62,'CASH_OUT',990000,'C2031',1340000,350000,'CASH17',0,0,1,1),
(63,'TRANSFER',440000,'C1042',650000,210000,'C2032',260000,700000,0,0),
(64,'PAYMENT',7800,'C1043',19000,11200,'M1015',0,0,0,0),
(65,'TRANSFER',1650000,'C1044',1900000,250000,'C2033',300000,1850000,1,1),
(66,'CASH_OUT',1650000,'C2033',1850000,300000,'CASH18',0,0,1,1),
(67,'TRANSFER',380000,'C1045',600000,220000,'C2034',250000,630000,0,0),
(68,'PAYMENT',5400,'C1046',15000,9600,'M1016',0,0,0,0),
(69,'TRANSFER',980000,'C1047',1100000,120000,'C2035',400000,1380000,1,1),
(70,'CASH_OUT',980000,'C2035',1380000,400000,'CASH19',0,0,1,1),

(71,'TRANSFER',460000,'C1048',700000,240000,'C2036',300000,760000,0,0),
(72,'PAYMENT',6800,'C1049',18000,11200,'M1017',0,0,0,0),
(73,'TRANSFER',1500000,'C1050',1750000,250000,'C2037',350000,1850000,1,1),
(74,'CASH_OUT',1500000,'C2037',1850000,350000,'CASH20',0,0,1,1),
(75,'TRANSFER',420000,'C1051',650000,230000,'C2038',260000,680000,0,0),
(76,'PAYMENT',7200,'C1052',17000,9800,'M1018',0,0,0,0),
(77,'TRANSFER',990000,'C1053',1200000,210000,'C2039',300000,1290000,1,1),
(78,'CASH_OUT',990000,'C2039',1290000,300000,'CASH21',0,0,1,1),
(79,'TRANSFER',480000,'C1054',700000,220000,'C2040',250000,730000,0,0),
(80,'PAYMENT',6400,'C1055',16000,9600,'M1019',0,0,0,0),

(81,'TRANSFER',1600000,'C1056',1850000,250000,'C2041',300000,1850000,1,1),
(82,'CASH_OUT',1600000,'C2041',1850000,300000,'CASH22',0,0,1,1),
(83,'TRANSFER',390000,'C1057',600000,210000,'C2042',260000,650000,0,0),
(84,'PAYMENT',7600,'C1058',18000,10400,'M1020',0,0,0,0),
(85,'TRANSFER',980000,'C1059',1150000,170000,'C2043',350000,1330000,1,1),
(86,'CASH_OUT',980000,'C2043',1330000,350000,'CASH23',0,0,1,1),
(87,'TRANSFER',450000,'C1060',700000,250000,'C2044',300000,750000,0,0),
(88,'PAYMENT',5200,'C1061',15000,9800,'M1021',0,0,0,0),
(89,'TRANSFER',1700000,'C1062',2000000,300000,'C2045',350000,2050000,1,1),
(90,'CASH_OUT',1700000,'C2045',2050000,350000,'CASH24',0,0,1,1),

(91,'TRANSFER',420000,'C1063',650000,230000,'C2046',260000,680000,0,0),
(92,'PAYMENT',6100,'C1064',16000,9900,'M1022',0,0,0,0),
(93,'TRANSFER',990000,'C1065',1200000,210000,'C2047',300000,1290000,1,1),
(94,'CASH_OUT',990000,'C2047',1290000,300000,'CASH25',0,0,1,1),
(95,'TRANSFER',480000,'C1066',700000,220000,'C2048',250000,730000,0,0),
(96,'PAYMENT',7300,'C1067',17000,9700,'M1023',0,0,0,0),
(97,'TRANSFER',1550000,'C1068',1800000,250000,'C2049',350000,1850000,1,1),
(98,'CASH_OUT',1550000,'C2049',1850000,350000,'CASH26',0,0,1,1),
(99,'TRANSFER',450000,'C1069',700000,250000,'C2050',300000,750000,0,0),
(100,'PAYMENT',8000,'C1070',20000,12000,'M1024',0,0,0,0);

SELECT COUNT(*)
FROM transactions;

SELECT *
FROM transactions;

/* Step1 Transaction landscape (risk profiling) */

SELECT type,
		COUNT(*) AS txn_count,
        SUM(amount) AS total_amount
FROM transactions
GROUP BY type;

/* Step2 High Value transaction rule */

SELECT COUNT(*) AS high_value
FROM transactions
WHERE amount > 1000000;

SELECT *
FROM transactions
WHERE amount > 1000000;

/* Step 3 Structuring/ Smurfing detection */

SELECT nameOrig,
		COUNT(*) AS txn_count,
        SUM(amount) AS total_amount
FROM transactions
WHERE amount BETWEEN 950000 AND 999999
GROUP BY nameOrig
HAVING COUNT(*) >= 2;

/* Step 4 Rapid Movement of Funds(velocity) */

SELECT nameOrig,
		COUNT(*) AS txn_count
FROM transactions
WHERE step BETWEEN 1 AND 10
GROUP BY nameOrig
HAVING COUNT(*) > 2;

/* Step 5 Account Draining Pattern */

SELECT *
FROM transactions
WHERE oldbalanceOrg > 0
	AND newbalanceOrig = 0;
    
/* Step 6 Transfer Immediate cash-out */

SELECT t1.nameOrig AS original_sender,
		t1.amount AS transfer_amount,
        t2.amount AS cashout_amount
FROM transactions t1
JOIN transactions t2
 ON t1.nameDest = t2.nameOrig
WHERE t1.type = "TRANSFER"
  AND t2.type = "CASH_OUT";
  
/* Step 7 Fraud Flag Validation creates confusion matrix */

SELECT isFraud,
		IsFlaggedFraud,
        COUNT(*) AS cases
FROM transactions
GROUP BY Isfraud, IsFlaggedFraud;


/* Step 8 High risk account identification */

SELECT nameOrig,
		COUNT(*) AS total_txns,
        SUM(isFraud) AS Fraud_cases
FROM transactions
GROUP BY nameOrig
HAVING SUM(IsFraud) >= 1;

/* Step 9 aml case summary ranking senders involved in fraudulent activity */

SELECT nameOrig,
		COUNT(*) AS total_txns,
        SUM(amount) AS total_amount,
        SUM(isFraud) AS fraud_flags
FROM transactions
GROUP BY nameOrig
HAVING SUM(isFraud) > 0
ORDER BY fraud_flags DESC;

/* Step 10 Risk scoring  */

SELECT nameOrig,
       SUM(
           CASE 
               WHEN amount > 1000000 THEN 3
               WHEN amount BETWEEN 950000 AND 999999 THEN 2
               ELSE 1
           END
       ) AS risk_score
FROM transactions
GROUP BY nameOrig
ORDER BY risk_score DESC;


/* Step 11 Final investigator view */

SELECT *
FROM transactions
WHERE isFraud = 1
ORDER BY step;
